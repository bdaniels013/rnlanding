<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Live Review Submission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#fff; margin:0; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 24px; background: #111827; border: 1px solid #1f2937; border-radius: 16px; }
    h1 { margin-top: 0; font-size: 1.75rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 0.9rem; margin-bottom: 8px; color: #cbd5e1; }
    .field input, .field select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0b1220; color: #fff; }
    .helper { font-size: 0.8rem; color: #94a3b8; }
    .button { width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; border: none; color: #fff;
      background: linear-gradient(90deg, #6366f1, #a855f7); cursor: pointer; }
    .button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .card { border: 1px solid #1f2937; border-radius: 12px; padding: 16px; background: #0b1220; }
    .status { margin-top: 16px; padding: 12px; border-radius: 12px; }
    .status.ok { background: #064e3b; color: #a7f3d0; border: 1px solid #10b981; }
    .status.err { background: #7f1d1d; color: #fecaca; border: 1px solid #ef4444; }
    .price { font-weight: bold; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Live Review Submission</h1>
    <p class="helper">Submit your track for a live review. Payment is $25. We’ll email the submission to the team after successful payment.</p>

    <form id="musicForm" class="card" enctype="multipart/form-data">
      <div class="grid">
        <div class="field">
          <label for="name">Your Name *</label>
          <input id="name" name="name" type="text" required placeholder="John Doe">
        </div>
        <div class="field">
          <label for="songName">Song Name *</label>
          <input id="songName" name="songName" type="text" required placeholder="My Track">
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label for="email">Your Email (optional)</label>
          <input id="email" name="email" type="email" placeholder="you@example.com">
        </div>
        <div class="field">
          <label for="mp3">Attach MP3 *</label>
          <input id="mp3" name="mp3" type="file" accept="audio/mpeg,audio/mp3" required>
          <div class="helper">MP3 only, max 20MB.</div>
        </div>
      </div>

      <div class="field">
        <label>Payment — $<span class="price">25.00</span></label>
        <div class="grid">
          <div class="field">
            <label for="cardNumber">Card Number *</label>
            <input id="cardNumber" type="text" inputmode="numeric" maxlength="19" placeholder="1234 5678 9012 3456" required>
          </div>
          <div class="field">
            <label for="cardName">Name on Card *</label>
            <input id="cardName" type="text" placeholder="John Doe" required>
          </div>
          <div class="field">
            <label for="expiry">Expiry (MM/YY) *</label>
            <input id="expiry" type="text" maxlength="5" placeholder="MM/YY" required>
          </div>
          <div class="field">
            <label for="cvv">CVV *</label>
            <input id="cvv" type="password" maxlength="4" placeholder="123" required>
          </div>
        </div>
      </div>

      <button id="submitBtn" class="button" type="submit">Submit & Pay $25</button>
      <div id="status" class="status" style="display:none;"></div>
    </form>
  </div>

  <script>
    const formatCardNumber = (val) =>
      val.replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, '$1 ').trim();
    const formatExpiry = (val) => {
      const v = val.replace(/\D/g, '').slice(0, 4);
      return v.length >= 3 ? v.slice(0,2) + '/' + v.slice(2) : v;
    };

    const form = document.getElementById('musicForm');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('submitBtn');

    const cardNumber = document.getElementById('cardNumber');
    const expiry = document.getElementById('expiry');

    cardNumber.addEventListener('input', (e) => e.target.value = formatCardNumber(e.target.value));
    expiry.addEventListener('input', (e) => e.target.value = formatExpiry(e.target.value));

    function showStatus(ok, msg) {
      statusEl.style.display = 'block';
      statusEl.className = 'status ' + (ok ? 'ok' : 'err');
      statusEl.textContent = msg;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      showStatus(true, 'Processing your submission...');
      btn.disabled = true;

      const name = document.getElementById('name').value.trim();
      const songName = document.getElementById('songName').value.trim();
      const email = document.getElementById('email').value.trim();
      const mp3File = document.getElementById('mp3').files[0];
      const cardName = document.getElementById('cardName').value.trim();
      const cvv = document.getElementById('cvv').value.trim();

      if (!name || !songName || !mp3File || !cardNumber.value || !expiry.value || !cvv || !cardName) {
        showStatus(false, 'Please fill out all required fields.');
        btn.disabled = false;
        return;
      }

      try {
        // 1) Upload MP3
        const fd = new FormData();
        fd.append('mp3', mp3File);
        const uploadResp = await fetch('/api/music-submission/upload', { method: 'POST', body: fd });
        const uploadData = await uploadResp.json();
        if (!uploadResp.ok || !uploadData.success) {
          throw new Error(uploadData.error || 'Failed to upload MP3');
        }

        // 2) Charge $25 via Payment Cloud (NMI)
        const paymentReq = {
          method: 'card',
          customer_info: { name, email },
          payment_data: {
            number: cardNumber.value,
            expiry: expiry.value,
            cvv: cvv,
            name: cardName
          },
          amount: 2500, // cents
          offer_id: 'music-submission'
        };

        const chargeResp = await fetch('/api/payment-cloud/charge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(paymentReq),
        });
        const chargeData = await chargeResp.json();
        if (!chargeResp.ok || !chargeData.success) {
          throw new Error(chargeData.error || 'Payment failed');
        }

        // 3) Send the submission email with the MP3 attached
        const notifyResp = await fetch('/api/music-submission/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            songName,
            email,
            fileUrl: uploadData.fileUrl,
            transaction: chargeData
          })
        });
        const notifyData = await notifyResp.json();
        if (!notifyResp.ok || !notifyData.success) {
          throw new Error(notifyData.error || 'Failed to send submission email');
        }

        showStatus(true, 'Success! Your track was submitted and payment completed.');
        form.reset();
      } catch (err) {
        console.error(err);
        showStatus(false, err.message || 'Something went wrong. Please try again.');
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>